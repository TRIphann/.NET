@model QLDuLichRBAC_Upgrade.Models.Entities.Tour

@{
    ViewData["Title"] = "Chi tiết Tour - " + Model.TenTour;
}

<link rel="stylesheet" href="~/css/customer-layout.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .tour-detail-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .tour-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
    }

    .tour-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
    }

    .tour-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        padding: 25px;
        background: #f8f9fa;
    }

    .tour-gallery img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        cursor: pointer;
    }

    .tour-gallery img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Modal phóng to ảnh */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.95);
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .image-modal-content {
        position: relative;
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
        top: 50%;
        transform: translateY(-50%);
        animation: zoomIn 0.3s ease;
        border-radius: 10px;
    }

    @@keyframes zoomIn {
        from { transform: translateY(-50%) scale(0.5); }
        to { transform: translateY(-50%) scale(1); }
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 40px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10000;
    }

    .modal-close:hover {
        color: #667eea;
        transform: scale(1.2);
    }

    .modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-size: 50px;
        cursor: pointer;
        padding: 20px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        transition: all 0.3s ease;
        user-select: none;
    }

    .modal-nav:hover {
        background: rgba(102, 126, 234, 0.8);
    }

    .modal-prev { left: 20px; }
    .modal-next { right: 20px; }

    .image-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 18px;
        background: rgba(0,0,0,0.7);
        padding: 10px 20px;
        border-radius: 20px;
    }

    .tour-body { padding: 30px; }

    .info-section {
        margin-bottom: 30px;
    }

    .info-section h3 {
        color: #667eea;
        font-size: 22px;
        margin-bottom: 15px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    .info-row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }

    .info-label {
        font-weight: 600;
        width: 180px;
        color: #555;
    }

    .info-value { flex: 1; color: #333; }

    .guide-card {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .guide-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
        border: 4px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .guide-info h4 {
        margin: 0 0 8px 0;
        font-size: 20px;
        color: #333;
    }

    .guide-info p { margin: 5px 0; color: #666; }

    .itinerary-list { list-style: none; padding: 0; }

    .itinerary-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .day-badge {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 10px;
    }

    .price-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        margin-top: 30px;
    }

    .price-section h2 {
        margin: 0 0 10px 0;
        font-size: 36px;
    }

    .booking-form {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }

    .service-checkbox {
        display: flex;
        align-items: center;
        padding: 12px;
        background: white;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 2px solid #eee;
        transition: all 0.3s ease;
    }

    .service-checkbox:hover { border-color: #667eea; }

    .service-checkbox input {
        margin-right: 12px;
        width: 20px;
        height: 20px;
    }

    .service-info { flex: 1; }
    .service-price { font-weight: 700; color: #667eea; }

    .btn-book-now {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-book-now:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-back {
        display: inline-block;
        padding: 12px 25px;
        background: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: #5a6268;
        transform: translateX(-5px);
    }
</style>

<div class="customer-layout">
    <!-- Sidebar -->
    <nav class="customer-sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-plane"></i> Du lịch</h2>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="@Url.Action("RegisterTour", "Customer")">
                    <i class="fas fa-list"></i>
                    <span>Danh sách Tour</span>
                </a>
            </li>
            <li>
                <a href="@Url.Action("PaidTours", "Customer")">
                    <i class="fas fa-check-circle"></i>
                    <span>Tour đã thanh toán</span>
                </a>
            </li>
            <li>
                <a href="@Url.Action("Profile", "Customer")">
                    <i class="fas fa-user"></i>
                    <span>Hồ sơ cá nhân</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-footer">
            <a href="@Url.Action("Logout", "Account")">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="customer-content">
        <a href="@Url.Action("RegisterTour", "Customer")" class="btn-back">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>

        <div class="tour-detail-container">
            <!-- Tour Header -->
            <div class="tour-header">
                <h1><i class="fas fa-map-marked-alt"></i> @Model.TenTour</h1>
                <p><i class="fas fa-calendar-alt"></i> @Model.NgayBatDau.ToString("dd/MM/yyyy") - @Model.NgayKetThuc.ToString("dd/MM/yyyy")</p>
            </div>

            <!-- Tour Gallery -->
            @if (Model.Tour_Anh != null && Model.Tour_Anh.Any())
            {
            <div class="tour-gallery">
                @for (int i = 0; i < Model.Tour_Anh.Count; i++)
                    {
                        var anh = Model.Tour_Anh.ElementAt(i);
                <img src="~/images/@anh.DuongDan" alt="@Model.TenTour" onclick="openImageModal(@i)" />
                    }
            </div>
            }

            <!-- Tour Body -->
            <div class="tour-body">
                <!-- Thông tin cơ bản -->
                <div class="info-section">
                    <h3><i class="fas fa-info-circle"></i> Thông tin chung</h3>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-calendar-alt"></i> Ngày khởi hành:</span>
                        <span class="info-value">@Model.NgayBatDau.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-calendar-check"></i> Ngày kết thúc:</span>
                        <span class="info-value">@Model.NgayKetThuc.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-clock"></i> Thời gian:</span>
                        <span class="info-value">@((Model.NgayKetThuc - Model.NgayBatDau).Days + 1) ngày</span>
                    </div>
                </div>

                <!-- Phương tiện -->
                @if (Model.Tour_PhuongTien != null && Model.Tour_PhuongTien.Any())
                {
                <div class="info-section">
                    <h3><i class="fas fa-bus"></i> Phương tiện di chuyển</h3>
                    @foreach (var pt in Model.Tour_PhuongTien)
                        {
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-shuttle-van"></i> @pt.PhuongTien?.LoaiPT:</span>
                        <span class="info-value">@pt.PhuongTien?.TenPT (Sức chứa: @pt.PhuongTien?.SoCho chỗ)</span>
                    </div>
                        }
                </div>
                }

                <!-- Địa điểm -->
                @if (Model.Tour_DiaDiem != null && Model.Tour_DiaDiem.Any())
                {
                <div class="info-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Các điểm đến</h3>
                    @foreach (var dd in Model.Tour_DiaDiem)
                        {
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-location-dot"></i> @dd.DiaDiem?.TenDD:</span>
                        <span class="info-value">@dd.DiaDiem?.Tinh</span>
                    </div>
                        }
                </div>
                }

                <!-- Lịch trình -->
                @if (Model.Tour_LichTrinhCT != null && Model.Tour_LichTrinhCT.Any())
                {
                <div class="info-section">
                    <h3><i class="fas fa-route"></i> Lịch trình chi tiết</h3>
                    <ul class="itinerary-list">
                        @foreach (var lt in Model.Tour_LichTrinhCT.OrderBy(x => x.LichTrinhCT?.NgayThu))
                            {
                        <li class="itinerary-item">
                            <span class="day-badge">Ngày @lt.LichTrinhCT?.NgayThu</span>
                            <strong>@lt.LichTrinhCT?.NoiDung</strong>
                        </li>
                            }
                    </ul>
                </div>
                }

                <!-- Hướng dẫn viên -->
                @if (Model.NhanVien_Tour != null && Model.NhanVien_Tour.Any())
                {
                <div class="info-section">
                    <h3><i class="fas fa-user-tie"></i> Hướng dẫn viên</h3>
                    @foreach (var nv in Model.NhanVien_Tour)
                        {
                    <div class="guide-card">
                        <img src="~/images/@(nv.NhanVien?.AnhDaiDien ?? "guides/default.jpg")"
                             alt="@nv.NhanVien?.TenNV"
                             class="guide-avatar"
                             onerror="this.src='/images/guides/default.jpg'" />
                        <div class="guide-info">
                            <h4><i class="fas fa-user"></i> @nv.NhanVien?.TenNV</h4>
                            <p><i class="fas fa-venus-mars"></i> Giới tính: @nv.NhanVien?.GioiTinh</p>
                            <p><i class="fas fa-phone"></i> Điện thoại: @nv.NhanVien?.SDT</p>
                        </div>
                    </div>
                        }
                </div>
                }

                <!-- Giá và đặt tour -->
                <div class="price-section">
                    <h2>@Model.Gia.ToString("N0") ₫</h2>
                    <p>Giá trên mỗi người</p>
                </div>

                <!-- Form đặt tour -->
                <div class="booking-form">
                    <h3><i class="fas fa-ticket-alt"></i> Đặt tour ngay</h3>
                    <form asp-action="Payment" method="get">
                        <input type="hidden" name="tourId" value="@Model.MaTour" />

                        <div class="form-group">
                            <label><i class="fas fa-users"></i> Số lượng vé:</label>
                            <input type="number" name="soLuongVe" class="form-control" value="1" min="1" max="20" required />
                        </div>

                        @if (ViewBag.DichVuList != null)
                        {
                        <div class="form-group">
                            <label><i class="fas fa-concierge-bell"></i> Dịch vụ đi kèm (tùy chọn):</label>
                            @foreach (var dv in (List<QLDuLichRBAC_Upgrade.Models.Entities.DichVuDiKem>)ViewBag.DichVuList)
                                {
                            <div class="service-checkbox">
                                <input type="checkbox" name="dichVuIds" value="@dv.MaDV" id="dv_@dv.MaDV" />
                                <label for="dv_@dv.MaDV" class="service-info">
                                    <strong>@dv.TenDV</strong><br />
                                    <small>@dv.MoTa</small>
                                </label>
                                <span class="service-price">+@dv.DonGia.ToString("N0") ₫</span>
                            </div>
                                }
                        </div>
                        }

                        <button type="submit" class="btn-book-now">
                            <i class="fas fa-credit-card"></i> Đặt tour ngay
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <span class="modal-nav modal-prev" onclick="event.stopPropagation(); changeImage(-1)">&#10094;</span>
    <img class="image-modal-content" id="modalImage">
    <span class="modal-nav modal-next" onclick="event.stopPropagation(); changeImage(1)">&#10095;</span>
    <div class="image-counter" id="imageCounter"></div>
</div>

<script>
    // Danh sách ảnh
    const images = [
        @if (Model.Tour_Anh != null && Model.Tour_Anh.Any())
        {
            @:[@string.Join(", ", Model.Tour_Anh.Select(a => $"'/images/{a.DuongDan}'"))]
        }
        else
        {
            @:[]
        }
    ];

    let currentImageIndex = 0;

    // Mở modal
    function openImageModal(index) {
        currentImageIndex = index;
        document.getElementById('imageModal').style.display = 'block';
        showImage();
    }

    // Đóng modal
    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // Hiển thị ảnh
    function showImage() {
        const modalImage = document.getElementById('modalImage');
        const counter = document.getElementById('imageCounter');

        modalImage.src = images[currentImageIndex];
        counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
    }

    // Chuyển ảnh
    function changeImage(direction) {
        currentImageIndex += direction;

        if (currentImageIndex >= images.length) {
            currentImageIndex = 0;
        } else if (currentImageIndex < 0) {
            currentImageIndex = images.length - 1;
        }

        showImage();
    }

    // Phím tắt
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('imageModal');
        if (modal.style.display === 'block') {
            if (e.key === 'Escape') closeImageModal();
            if (e.key === 'ArrowLeft') changeImage(-1);
            if (e.key === 'ArrowRight') changeImage(1);
        }
    });

    // Script tính tổng tiền động
    document.addEventListener('DOMContentLoaded', function() {
        const soLuongVeInput = document.querySelector('input[name="soLuongVe"]');
        const dichVuCheckboxes = document.querySelectorAll('input[name="dichVuIds"]');
        const giaTour = @Model.Gia;

        function updateTotal() {
            const soLuongVe = parseInt(soLuongVeInput.value) || 1;
            let tongTien = giaTour * soLuongVe;

            dichVuCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const priceText = checkbox.closest('.service-checkbox').querySelector('.service-price').textContent;
                    const price = parseInt(priceText.replace(/[^0-9]/g, ''));
                    tongTien += price;
                }
            });

            console.log('Tổng tiền:', tongTien);
        }

        if (soLuongVeInput) soLuongVeInput.addEventListener('input', updateTotal);
        dichVuCheckboxes.forEach(cb => cb.addEventListener('change', updateTotal));
    });
</script>
