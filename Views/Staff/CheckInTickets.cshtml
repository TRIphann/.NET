@model IEnumerable<QLDuLichRBAC_Upgrade.Models.Entities.Ve>

@{
    ViewData["Title"] = "Check-in vé - Jumparena Staff";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<style>
    .checkin-hero {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        padding: 50px 20px;
        text-align: center;
        margin: -20px -20px 40px -20px;
        border-radius: 0 0 30px 30px;
    }

    .checkin-hero h1 {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .scanner-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .qr-scanner {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
        border-radius: 15px;
        margin-bottom: 20px;
    }

    .scan-input {
        width: 100%;
        padding: 15px 20px;
        font-size: 1.2em;
        border: 3px solid #667eea;
        border-radius: 12px;
        text-align: center;
        font-weight: bold;
        letter-spacing: 2px;
    }

    .scan-input:focus {
        outline: none;
        border-color: #43e97b;
        box-shadow: 0 0 0 3px rgba(67, 233, 123, 0.2);
    }

    .btn-scan {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
    }

    .btn-scan:hover {
        transform: scale(1.02);
    }

    .scan-result {
        display: none;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        text-align: center;
    }

    .scan-result.success {
        background: #d4edda;
        border: 2px solid #28a745;
        color: #155724;
    }

    .scan-result.error {
        background: #f8d7da;
        border: 2px solid #dc3545;
        color: #721c24;
    }

    .tickets-table {
        width: 100%;
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .tickets-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .tickets-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .tickets-table td {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .tickets-table tr:hover {
        background: #f8f9ff;
    }

    .ticket-code-badge {
        background: #667eea;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
        letter-spacing: 1px;
    }

    .btn-checkin-row {
        padding: 8px 16px;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }

    .btn-checkin-row:hover {
        transform: scale(1.05);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        color: #666;
        margin-top: 5px;
    }
</style>

<div class="checkin-hero">
    <h1><i class="fas fa-qrcode"></i> Check-in Vé</h1>
    <p>Quét mã vé hoặc nhập mã thủ công</p>
</div>

@if (!string.IsNullOrEmpty(ViewBag.Message as string))
{
    <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border: 2px solid #ffc107; margin-bottom: 30px; text-align: center;">
        <i class="fas fa-info-circle" style="color: #856404;"></i>
        <strong style="color: #856404;">@ViewBag.Message</strong>
    </div>
}
else
{
    @if (Model != null && Model.Any())
    {
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">@Model.Count()</div>
                <div class="stat-label">Tổng vé hôm nay</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@Model.Sum(v => v.SoNguoi)</div>
                <div class="stat-label">Tổng khách</div>
            </div>
        </div>
    }

    <div class="scanner-section">
        <h3 style="margin-bottom: 20px; text-align: center;"><i class="fas fa-camera"></i> Quét mã vé</h3>
        
        <div class="qr-scanner">
            <input type="text" id="ticketCodeInput" class="scan-input" placeholder="Nhập hoặc quét mã vé" autofocus />
            <button type="button" class="btn-scan" onclick="checkInTicket()">
                <i class="fas fa-check-circle"></i> Check-in
            </button>
        </div>

        <div id="scanResult" class="scan-result"></div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="tickets-table">
            <table>
                <thead>
                    <tr>
                        <th>Mã vé</th>
                        <th>Gói dịch vụ</th>
                        <th>Ca</th>
                        <th>Số người</th>
                        <th>Khách hàng</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in Model)
                    {
                        <tr>
                            <td>
                                <span class="ticket-code-badge">@ticket.MaVeCode</span>
                            </td>
                            <td>@ticket.GoiDichVu?.TenGoi</td>
                            <td>N/A</td>
                            <td><i class="fas fa-users"></i> @ticket.SoNguoi người</td>
                            <td>@(ticket.KhachHang?.TenKH ?? "N/A")</td>
                            <td>
                                <button class="btn-checkin-row" onclick="checkInByCode('@ticket.MaVeCode')">
                                    <i class="fas fa-check"></i> Check-in
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

@section Scripts {
<script>
    // Auto-focus input
    document.getElementById('ticketCodeInput').focus();

    // Enter key to check-in
    document.getElementById('ticketCodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkInTicket();
        }
    });

    function checkInTicket() {
        const ticketCode = document.getElementById('ticketCodeInput').value.trim();
        if (!ticketCode) {
            showResult('error', 'Vui lòng nhập mã vé');
            return;
        }
        checkInByCode(ticketCode);
    }

    async function checkInByCode(ticketCode) {
        try {
            const response = await fetch('/Staff/CheckIn?ticketCode=' + encodeURIComponent(ticketCode), {
                method: 'POST'
            });

            const result = await response.json();
            
            if (result.success) {
                showResult('success', 
                    `✅ Check-in thành công!<br>` +
                    `<strong>${result.packageName}</strong><br>` +
                    `Ca: ${result.timeSlot} | Số người: ${result.people}`
                );
                document.getElementById('ticketCodeInput').value = '';
                
                // Reload page after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showResult('error', '❌ ' + result.message);
            }
        } catch (error) {
            showResult('error', '❌ Lỗi: ' + error.message);
        }
    }

    function showResult(type, message) {
        const resultDiv = document.getElementById('scanResult');
        resultDiv.className = 'scan-result ' + type;
        resultDiv.innerHTML = message;
        resultDiv.style.display = 'block';

        // Auto-focus input after showing result
        setTimeout(() => {
            document.getElementById('ticketCodeInput').focus();
        }, 100);
    }
</script>
}
