@model IEnumerable<QLDuLichRBAC_Upgrade.Models.Entities.NhanVien_Tour>

    @{
    ViewData["Title"] = "Tour đã đăng ký";
    Layout = "~/Views/Shared/_GuideLayout.cshtml";
    decimal totalSalary = 0;
    }

    <div class="content-header">
        <h1><i class="fas fa-check-circle"></i> Tour đã đăng ký và Lương</h1>
    </div>

    @if (Model != null && Model.Any())
{
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Tên Tour</th>
                    <th>Ngày khởi hành</th>
                    <th>Ngày kết thúc</th>
                    <th>Giá Tour</th>
                    <th>Lương (50%)</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var salary = item.Tour.Gia * 0.5m;
                    totalSalary += salary;
                    var isPast = item.Tour.NgayKetThuc < DateTime.Today;
                    var isCurrent = item.Tour.NgayBatDau <= DateTime.Today && item.Tour.NgayKetThuc >= DateTime.Today;

                <tr>
                    <td>
                        <strong>@item.Tour.TenTour</strong>
                        @if (item.Tour.Tour_DiaDiem != null && item.Tour.Tour_DiaDiem.Any())
                            {
                        <br />
                        <small style="color: #666;">
                            <i class="fas fa-map-marker-alt"></i>
                            @string.Join(", ", item.Tour.Tour_DiaDiem.Take(2).Select(dd => dd.DiaDiem?.TenDD))
                        </small>
                            }
                    </td>
                    <td>@item.Tour.NgayBatDau.ToString("dd/MM/yyyy")</td>
                    <td>@item.Tour.NgayKetThuc.ToString("dd/MM/yyyy")</td>
                    <td style="color: #e74c3c; font-weight: 600;">
                        @item.Tour.Gia.ToString("N0") ₫
                    </td>
                    <td style="color: #27ae60; font-weight: 600; font-size: 1.1rem;">
                        @salary.ToString("N0") ₫
                    </td>
                    <td>
                        @if (isPast)
                            {
                        <span style="background: #95a5a6; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">
                            <i class="fas fa-check"></i> Đã hoàn thành
                        </span>
                            }
                            else if (isCurrent)
                            {
                        <span style="background: #3498db; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">
                            <i class="fas fa-spinner"></i> Đang diễn ra
                        </span>
                            }
                            else
                            {
                        <span style="background: #f39c12; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">
                            <i class="fas fa-clock"></i> Sắp diễn ra
                        </span>
                            }
                    </td>
                    <td>
                        @if (!isPast && !isCurrent)
                            {
                        <button class="btn btn-danger"
                                onclick="unregisterTour(@item.MaTour, '@item.Tour.TenTour')">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                            }
                            else
                            {
                        <span style="color: #999;">Không thể hủy</span>
                            }
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="total-salary">
        <h3>Tổng lương dự kiến</h3>
        <div class="amount">@totalSalary.ToString("N0") ₫</div>
        <small style="opacity: 0.9;">Từ @Model.Count() tour đã đăng ký</small>
    </div>
}
else
{
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
        <i class="fas fa-clipboard-list" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
        <h3 style="color: #999; margin-bottom: 10px;">Bạn chưa đăng ký tour nào</h3>
        <p style="color: #999; margin-bottom: 20px;">Hãy đăng ký làm hướng dẫn viên cho các tour để bắt đầu kiếm tiền!</p>
        <a href="@Url.Action("AvailableTours", "Guide")" class="btn btn-primary">
            <i class="fas fa-plus"></i> Xem danh sách tour
        </a>
    </div>
}

    @section Scripts {
        <script>
        function unregisterTour(tourId, tourName) {
            if (!confirm('Bạn có chắc muốn hủy đăng ký tour "' + tourName + '"?')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("UnregisterTour", "Guide")',
                type: 'POST',
                data: { tourId: tourId },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra. Vui lòng thử lại!');
                }
            });
        }
        </script>
    }
