@model QLDuLichRBAC_Upgrade.Models.Entities.Tour

@{
    ViewData["Title"] = "Chỉnh sửa Tour";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var nhanViens = ViewBag.NhanViens as List<QLDuLichRBAC_Upgrade.Models.Entities.NhanVien>;
    var diaDiems = ViewBag.DiaDiems as List<QLDuLichRBAC_Upgrade.Models.Entities.DiaDiem>;
    var phuongTiens = ViewBag.PhuongTiens as List<QLDuLichRBAC_Upgrade.Models.Entities.PhuongTien>;

    var selectedDiaDiems = Model.Tour_DiaDiem?.Select(td => td.MaDD).ToList() ?? new List<int>();
    var selectedPhuongTiens = Model.Tour_PhuongTien?.Select(tp => tp.MaPT).ToList() ?? new List<int>();
    var selectedNhanVien = Model.NhanVien_Tour?.FirstOrDefault()?.MaNV;
}

<style>
    .form-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 900px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
    }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

    .current-image {
        max-width: 200px;
        max-height: 150px;
        border-radius: 5px;
        margin-top: 10px;
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
    }

        .btn-submit:hover {
            opacity: 0.9;
        }

    .btn-cancel {
        background: #95a5a6;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-block;
    }

        .btn-cancel:hover {
            background: #7f8c8d;
        }
</style>

<h1><i class="fas fa-edit"></i> Chỉnh sửa Tour: @Model.TenTour</h1>

@if (TempData["Error"] != null)
{
<div class="alert alert-error">
    <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
</div>
}

<div class="form-container">
    <form asp-action="EditTour" method="post" enctype="multipart/form-data">
        <input type="hidden" name="MaTour" value="@Model.MaTour" />

        <div class="form-group">
            <label for="TenTour"><i class="fas fa-tag"></i> Tên Tour *</label>
            <input type="text" id="TenTour" name="TenTour" class="form-control" value="@Model.TenTour" required />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="NgayBatDau"><i class="fas fa-calendar-alt"></i> Ngày bắt đầu *</label>
                <input type="date" id="NgayBatDau" name="NgayBatDau" class="form-control"
                       value="@Model.NgayBatDau.ToString("yyyy-MM-dd")" required />
            </div>

            <div class="form-group">
                <label for="NgayKetThuc"><i class="fas fa-calendar-check"></i> Ngày kết thúc *</label>
                <input type="date" id="NgayKetThuc" name="NgayKetThuc" class="form-control"
                       value="@Model.NgayKetThuc.ToString("yyyy-MM-dd")" required />
            </div>
        </div>

        <div class="form-group">
            <label for="Gia"><i class="fas fa-dollar-sign"></i> Giá tour (VND) *</label>
            <input type="number" id="Gia" name="Gia" class="form-control" value="@Model.Gia"
                   min="0" step="1000" required />
        </div>

        <div class="form-group">
            <label for="MoTa"><i class="fas fa-align-left"></i> Mô tả</label>
            <textarea id="MoTa" name="MoTa" class="form-control" rows="4">@Model.MoTa</textarea>
        </div>

        <div class="form-group">
            <label for="anhDaiDien"><i class="fas fa-image"></i> Ảnh đại diện</label>
            @if (!string.IsNullOrEmpty(Model.AnhDaiDien))
            {
            <div>
                <img src="~/images/@Model.AnhDaiDien" alt="Current" class="current-image" />
                <p style="color: #999; font-size: 13px; margin-top: 5px;">Ảnh hiện tại</p>
            </div>
            }
            <input type="file" id="anhDaiDien" name="anhDaiDien" class="form-control" accept="image/*" />
            <small style="color: #999;">Để trống nếu không muốn thay đổi ảnh</small>
        </div>

        <div class="form-group">
            <label><i class="fas fa-user-tie"></i> Hướng dẫn viên</label>
            <select name="maNV" class="form-control">
                <option value="">-- Chọn hướng dẫn viên --</option>
                @if (nhanViens != null)
                {
                @foreach (var nv in nhanViens)
                    {
                <option value="@nv.MaNV" selected="@(selectedNhanVien == nv.MaNV)">
                    @nv.TenNV - @nv.SDT
                </option>
                    }
                }
            </select>
        </div>

        <div class="form-group">
            <label><i class="fas fa-map-marker-alt"></i> Địa điểm tham quan</label>
            <div class="checkbox-group" id="diaDiemGroup">
                @if (diaDiems != null)
                {
                @foreach (var dd in diaDiems)
                    {
                <label>
                    <input type="checkbox" name="diaDiemCheck" value="@dd.MaDD"
                           checked="@selectedDiaDiems.Contains(dd.MaDD)" />
                    @dd.TenDD - @dd.Tinh
                </label>
                    }
                }
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-bus"></i> Phương tiện</label>
            <div class="checkbox-group" id="phuongTienGroup">
                @if (phuongTiens != null)
                {
                @foreach (var pt in phuongTiens)
                    {
                <label>
                    <input type="checkbox" name="phuongTienCheck" value="@pt.MaPT"
                           checked="@selectedPhuongTiens.Contains(pt.MaPT)" />
                    @pt.TenPT (@pt.LoaiPT)
                </label>
                    }
                }
            </div>
        </div>

        <input type="hidden" id="diaDiemIds" name="diaDiemIds" value="@string.Join(",", selectedDiaDiems)" />
        <input type="hidden" id="phuongTienIds" name="phuongTienIds" value="@string.Join(",", selectedPhuongTiens)" />

        <div style="margin-top: 30px;">
            <button type="submit" class="btn-submit">
                <i class="fas fa-save"></i> Cập nhật tour
            </button>
            <a href="@Url.Action("Tours")" class="btn-cancel">
                <i class="fas fa-times"></i> Hủy
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Xử lý checkbox địa điểm
        document.querySelectorAll('input[name="diaDiemCheck"]').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const checkedIds = Array.from(document.querySelectorAll('input[name="diaDiemCheck"]:checked'))
                    .map(cb => cb.value);
                document.getElementById('diaDiemIds').value = checkedIds.join(',');
            });
        });

        // Xử lý checkbox phương tiện
        document.querySelectorAll('input[name="phuongTienCheck"]').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const checkedIds = Array.from(document.querySelectorAll('input[name="phuongTienCheck"]:checked'))
                    .map(cb => cb.value);
                document.getElementById('phuongTienIds').value = checkedIds.join(',');
            });
        });

        // Validate ngày kết thúc phải sau ngày bắt đầu
        document.getElementById('NgayBatDau').addEventListener('change', function () {
            document.getElementById('NgayKetThuc').min = this.value;
        });
    </script>
}
